#FIXME write tests both with and without shadow cap.
